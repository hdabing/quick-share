<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>{{ room_id }}</title>
  <script type="text/javascript" src="//code.jquery.com/jquery-1.4.2.min.js"></script>
  <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.5/socket.io.min.js"></script>
  <script type="text/javascript" charset="utf-8">
      var socket
      $(document).ready(function(){
          namespace = '/chat'; // change to an empty string to use the global namespace

          // the socket.io documentation recommends sending an explicit package upon connection
          // this is specially important when using the global namespace
          socket = io.connect('http://' + document.domain + ':' + location.port + namespace);


          // 新连接处理
          socket.on('connect', function() {
              socket.emit('join room', {room_id: "{{ room_id }}"});
          });

          // 处理系统消息
          socket.on('system message', function(message) {
            console.log('system message');
            console.log(message);
              $('#log').append('<br>' + $('<div/>').text(message.content).html());
          })


          // 处理用户数目变化
          socket.on('user update', function(message) {
              console.log('user update');
              console.log(message);
              $('#user-num').html(message.nick_name);
              $('#log').append('<br>' + $('<div/>').text(message.uid).html());
          })

          // 处理新消息
          socket.on('user message', function(message) {
            console.log('user message');
            console.log(message);
              $('#log').append('<br>' + $('<div/>').text(message.nick_name + ':' + message.content + '(' + message.message_time * 1000 + ')').html());
          });

          // 发送新消息
          $('#send').click(function(event) {
              var current_time = new Date().getTime();
              socket.emit('user message', {room_id: "{{ room_id}}", content: $('#message').val(), message_time: current_time/1000});
          })
      });
      window.onbeforeunload = function() {
          socket.emit('leave room', {room_id: "{{ room_id }}" });
      }
  </script>
</head>
<body>
  <h1>欢迎来到房间{{ room_id }}， 当前在线人数<span id='user-num'>0</span></h1>
  <input type="text" id="message" value="">
  <input type="button" id="send" value="发送">
  <h2>我的消息框:</h2>
  <div id="log"></div>
</body>
</html>
